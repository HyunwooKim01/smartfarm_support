-- ë¨¼ì € í™•ì¥ ëª¨ë“ˆ ì„¤ì¹˜ (TimescaleDBë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•¨)
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- ğŸ“Œ STEP 1: ê¸°ì¡´ ê°ì²´ ì „ì²´ ì œê±°
DROP MATERIALIZED VIEW IF EXISTS daily_sensor_avg;
DROP TABLE IF EXISTS board_comments;
DROP TABLE IF EXISTS board_posts;
DROP TABLE IF EXISTS sensor_logs;
DROP TABLE IF EXISTS device_controls;
DROP TABLE IF EXISTS device_status;
DROP TABLE IF EXISTS environment_settings;
DROP TABLE IF EXISTS user_plants;
DROP TABLE IF EXISTS devices;
DROP TABLE IF EXISTS users;

-- ğŸ‘¤ ì‚¬ìš©ì í…Œì´ë¸”
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    user_name TEXT NOT NULL,
    nickname TEXT UNIQUE NOT NULL,
    farm_location TEXT,
    role TEXT DEFAULT 'user',
    provider TEXT DEFAULT 'local',
    created_at TIMESTAMPTZ DEFAULT now()
);

-- ğŸŒ¿ ì‚¬ìš©ìë³„ ì‹ë¬¼ í…Œì´ë¸”
CREATE TABLE user_plants (
    plant_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id),
    plant_name TEXT NOT NULL,
    planted_at DATE,
    notes TEXT,
    temperature_optimal DOUBLE PRECISION,
    humidity_optimal DOUBLE PRECISION,
    soil_moisture_optimal DOUBLE PRECISION
);

-- ğŸ›  ì¥ì¹˜ í…Œì´ë¸” (ì„¼ì„œ/ì œì–´ê¸° êµ¬ë¶„ ì¶”ê°€)
CREATE TABLE devices (
    device_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id),
    category TEXT NOT NULL CHECK (category IN ('sensor', 'actuator')), -- ì„¼ì„œ or ì œì–´ê¸°
    type TEXT NOT NULL CHECK (
        type IN (
            'temperature', 'humidity', 'moisture',        -- ì„¼ì„œ
            'lighting', 'watering', 'fan'        -- ì œì–´ê¸°
        )
    ),
    name TEXT NOT NULL,
    location TEXT
);

-- ğŸ“Ÿ ì¥ì¹˜ ìƒíƒœ í…Œì´ë¸”
CREATE TABLE device_status (
    status_id SERIAL PRIMARY KEY,
    device_id INTEGER REFERENCES devices(device_id),
    device_status BOOLEAN,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ğŸŒ± í™˜ê²½ ê¸°ì¤€ì¹˜ ì„¤ì • í…Œì´ë¸”
CREATE TABLE environment_settings (
    setting_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id),
    temperature_threshold DOUBLE PRECISION,
    humidity_threshold DOUBLE PRECISION,
    soil_moisture_threshold DOUBLE PRECISION
);

-- ğŸ› ì œì–´ ê¸°ë¡ í…Œì´ë¸”
CREATE TABLE device_controls (
    control_id SERIAL PRIMARY KEY,
    device_id INTEGER REFERENCES devices(device_id),
    category TEXT NOT NULL CHECK (category IN ('ì„¼ì„œ', 'ì œì–´ê¸°')), -- ê³¼ê±° ì‚¬ìš© ë¶„ë¥˜, ìœ ì§€
    control_type TEXT CHECK (control_type IN ('lighting', 'watering', 'fan')),
    status BOOLEAN,
    controlled_at TIMESTAMPTZ DEFAULT NOW()
);

-- ğŸŒ¡ï¸ ì„¼ì„œ ë¡œê·¸ í…Œì´ë¸” (TimescaleDB í•˜ì´í¼í…Œì´ë¸”)
CREATE TABLE sensor_logs (
    time TIMESTAMPTZ NOT NULL,
    device_id INTEGER NOT NULL REFERENCES devices(device_id),
    sensor_type TEXT NOT NULL,
    sensor_value DOUBLE PRECISION NOT NULL,
    PRIMARY KEY (time, device_id, sensor_type)
);

-- TimescaleDB í•˜ì´í¼í…Œì´ë¸” ë“±ë¡
SELECT create_hypertable('sensor_logs', 'time', if_not_exists => TRUE);

-- ğŸ“Š ì¼ë³„ ì„¼ì„œ í‰ê· ê°’ View
CREATE MATERIALIZED VIEW daily_sensor_avg
WITH (timescaledb.continuous) AS
SELECT
  time_bucket('1 day', time) AS date,
  device_id,
  sensor_type,
  AVG(sensor_value) AS avg_value
FROM sensor_logs
GROUP BY time_bucket('1 day', time), device_id, sensor_type
WITH NO DATA;

-- ğŸ“ ê²Œì‹œê¸€ í…Œì´ë¸”
CREATE TABLE board_posts (
    post_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id),
    title TEXT NOT NULL,
    plant_type TEXT,
    content TEXT,
    images TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ğŸ’¬ ëŒ“ê¸€ í…Œì´ë¸”
CREATE TABLE board_comments (
    comment_id SERIAL PRIMARY KEY,
    post_id INTEGER REFERENCES board_posts(post_id),
    user_id INTEGER REFERENCES users(user_id),
    comment TEXT,
    commented_at TIMESTAMPTZ DEFAULT NOW()
);
